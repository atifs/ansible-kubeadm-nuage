
- hosts: "{{ cluster_name }}_master"
  become: true
  tasks:
    - name: add VSD key to authorized keys file
      authorized_key:
        user: root
        state: present
        key: "{{ lookup('file', '/tmp/vsd.id_rsa.pub') }}"

    - name: "Create user k8s-admin"
      local_action: command python /home/dev/ansible-kubeadm-nuage/files/nuage_create_user.py csproot {{ csproot_passwd }} csp {{ ansible_host }} k8s-admin k8s-admin k8s-admin@nuage.lab
      register: output

    - name: Verification Result Failure Status
      fail: msg={{ output.stdout }}
      when: output.stdout != "success"

    - name: Verification Result Success Status
      debug: var=output.stdout

- hosts: vsd
  become: true
  tasks:
    - name: "Add stat to VSD known_hosts list"
      shell: "ssh-keyscan -t rsa {{ master_ip_address_configured }} | sed -e 's/#.*$//' | sed -e '/^$/d' > /root/.ssh/known_hosts"


- hosts: "{{ cluster_name }}"
  become: true
  roles:
    - role: k8s-vsd-cert
      tags:
        - master

